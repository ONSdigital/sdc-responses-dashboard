<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SDC | Dashboard</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.7 -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.18/css/dataTables.bootstrap.min.css">
  <!-- Font Awesome -->
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">
  <!-- Theme style -->
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/AdminLTE.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/skins/skin-black.min.css') }}">
  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <style>
    #surveys_filter {
      display: none;
    }

    .modal-body {
      position: relative;
      padding: 0px 15px 15px 15px;
    }

    div.dataTables_wrapper div.dataTables_paginate {
      display: none;
    }

    .dataTables_scrollHeadInner {
      width: auto !important;
    }
  </style>

</head>

<body id="collex-id" data-collex="{{ collex_id }}" class="sidebar-mini skin-black sidebar-collapse">
  <!--sidebar-collapse-->
  <div class="wrapper">
    <header class="main-header">
      <!-- Logo -->
      <a href="" class="logo">
        <!-- mini logo for sidebar mini 50x50 pixels -->
        <span class="logo-mini">
          <b>R</b>D</span>
        <!-- logo for regular state and mobile devices -->
        <span class="logo-lg">
          <b>Responses</b>Dashboard</span>
      </a>
      <!-- Header Navbar: style can be found in header.less -->
      <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
          <span class="sr-only">Toggle navigation</span>
        </a>
        <!-- Navbar Right Menu -->
        <div class="navbar-custom-menu">
        </div>
      </nav>
    </header>
    <!-- Left side column. contains the logo and sidebar -->

    <aside class="main-sidebar">
      <!-- sidebar: style can be found in sidebar.less -->
      <section class="sidebar" style="height: auto;">
        <!-- Sidebar user panel -->
        <!-- sidebar menu: : style can be found in sidebar.less -->
        <ul class="sidebar-menu tree" data-widget="tree">
          <li class="header">MAIN NAVIGATION</li>
          <li class="active treeview menu-open">
            <ul class="treeview-menu">
              <li>
                <a href="" data-toggle="modal" data-target="#modal-default">
                  <i class="fa fa-arrow-right"></i> Choose Survey</a>
              </li>
            </ul>
          </li>
        </ul>
      </section>
      <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1 id="survey-name">
          {{ collection_exercise_name }}
        </h1>
        <ol class="breadcrumb">
          <li>
            <a href="#">
              <i class="fa fa-dashboard"></i> Home</a>
          </li>
          <li class="active">Dashboard</li>
        </ol>
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="modal fade" id="modal-default" style="display: none;">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">Ã—</span>
                </button>
                <h4 class="modal-title">Choose a survey</h4>
              </div>
              <div class="modal-body">
                <p>
                  <!-- search form -->
                  <div class="sidebar-form">
                    <div class="input-group">
                      <input type="text" id="survey-search" name="q" class="form-control" placeholder="Search...">
                      <span class="input-group-btn">
                        <button type="submit" name="search" id="search-btn" class="btn btn-flat">
                          <i class="fa fa-search"></i>
                        </button>
                      </span>
                    </div>
                  </div>
                  <!-- /.search form -->
                  <div id="example1_wrapper" class="dataTables_wrapper form-inline dt-bootstrap">
                    <div class="row">
                      <div class="col-sm-12">
                        <table id="surveys" class="table table-bordered table-striped dataTable" role="grid" aria-describedby="example1_info">
                          <thead>
                            <tr role="row">
                              <th class="sorting_asc" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-sort="ascending" aria-label="Rendering engine: activate to sort column descending"
                                style="width: 198px;">Survey</th>
                              <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="Browser: activate to sort column ascending"
                                style="width: 243px;">Reference</th>
                              <th class="sorting" tabindex="0" aria-controls="example1" rowspan="1" colspan="1" aria-label="Platform(s): activate to sort column ascending"
                                style="width: 216px;">Exercise Period</th>
                            </tr>
                          </thead>
                          <tbody>

                            {% for survey in all_surveys %} {% for collex in survey.collectionExercises %}
                            <tr role="row" class="even" id="{{ collex.collexId }}">
                              <td class="sorting_1">{{ survey.shortName }}</td>
                              <td>{{ survey.surveyRef }}</td>
                              <td>{{ collex.exerciseRef }}</td>
                            </tr>
                            {% endfor %} {% endfor %}

                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
              </div>
            </div>
            <!-- /.modal-content -->
          </div>
          <!-- /.modal-dialog -->
        </div>

        <div class="row">
          <div class="col-lg-6 col-xs-6">
            <!-- small box -->
            <div class="small-box bg-aqua">
              <div class="inner">
                <h3 id="downloads-counter">0</h3>
                <p>Downloads</p>
              </div>
              <div class="icon">
                <i class="fa fa-download"></i>
              </div>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-6 col-xs-6">
            <!-- small box -->
            <div class="small-box bg-green">
              <div class="inner">
                <h3 id="uploads-counter">0
                  <sup style="font-size: 20px"></sup>
                </h3>
                <p>Uploads</p>
              </div>
              <div class="icon">
                <i class="fa fa-upload"></i>
              </div>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-6 col-xs-6">
            <!-- small box -->
            <div class="small-box bg-yellow">
              <div class="inner">
                <h3 id="accounts-enrolled-counter">0</h3>
                <p>Accounts Enrolled</p>
              </div>
              <div class="icon">
                <i class="fa fa-users"></i>
              </div>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-6 col-xs-6">
            <!-- small box -->
            <div class="small-box bg-red">
              <div class="inner">
                <h3 id="sample-size-counter">0</h3>
                <p>Sample Size</p>
              </div>
              <div class="icon">
                <i class="fa fa-sitemap"></i>
              </div>
            </div>
          </div>
          <!-- ./col -->
        </div>

        <div class="row">
          <div class="col-md-12">
            <div id="collex-box" class="box">
              <div class="box-header with-border">
                <h3 class="box-title">Collection Exercise Progress</h3>
              </div>
              <!-- /.box-header -->
              <div class="box-body">
                <div class="row">
                  <!-- /.col -->
                  <div class="col-md-12">
                    <!-- /.progress-group -->
                    <div class="progress-group">
                      <span class="progress-text">Samples Completed</span>
                      <span class="progress-number">
                        <b>
                          <span id="progress-uploaded">160</span>
                        </b>/
                        <span id="progress-size">0</span>
                      </span>
                      <div class="progress md">
                        <div class="progress-bar progress-bar-red" id="collex-progress">0</div>
                      </div>
                    </div>
                  </div>
                  <!-- /.col -->
                </div>
                <!-- /.row -->
              </div>
              <!-- /.box-footer -->
            </div>
            <!-- /.box -->
          </div>
          <!-- /.col -->
        </div>

      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <footer class="main-footer">
      <div class="pull-right hidden-xs">
        <b>SDC Responses Dashboard</b> v2.0.0
      </div>
      <strong>Last Updated:
        <span id="time-updated">01/01/2018</span>
      </strong>
    </footer>

  </div>
  <!-- ./wrapper -->

  <!-- jQuery 3 -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
    crossorigin="anonymous"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/scroller/1.4.4/js/dataTables.scroller.min.js"></script>
  <!-- Moment JS -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.js"></script>
  <!-- App -->
  <script src="{{ url_for('static', filename='assets/js/adminlte.min.js') }}"></script>


  <script>
    $(document).ready(function () {

      callAPI()

      function callAPI(collex_id, enableTimeout) {

        if (collex_id == null & enableTimeout == null) {
          var collex_id = $('#collex-id').data()['collex'];
          var enableTimeout = true;
        };

        console.log(collex_id)
        $.ajax({
          url: {{ reporting_url|tojson }} + "reporting-api/v1/response-dashboard/collection_exercise/" + collex_id,
          success: function (result) {

            var downloads = result.report.downloads
            var uploads = result.report.uploads
            var accountsEnrolled = result.report.accountsEnrolled
            var sampleSize = result.report.sampleSize
            var timeUpdated = moment.unix(result.metadata.timeUpdated).calendar()
            var progress = (uploads / sampleSize * 100).toFixed(2)
            var progressClass = "w3-green"
            var collexBox = "box-success"
            if (progress < 26) {
              progressClass = "progress-bar-red";
              collexBox = "box-danger";
            } else if (progress > 25 & progress < 70) {
              progressClass = "progress-bar-yellow";
              collexBox = "box-warning"
            } else {
              progressClass = "progress-bar-green";
              collexBox = "box-success"
            }

            $("#downloads-counter").text(downloads).effect("bounce", "slow");
            $("#uploads-counter").text(uploads).effect("bounce", "slow");
            $("#accounts-enrolled-counter").text(accountsEnrolled).effect("bounce", "slow");
            $("#sample-size-counter").text(sampleSize).effect("bounce", "slow");
            $("#time-updated").text(timeUpdated);
            $("#progress-uploaded").text(uploads);
            $("#progress-size").text(sampleSize);

            $("#collex-progress").text(progress + "%").css("width", progress + "%").removeClass(
              "progress-bar-red progress-bar-yellow progress-bar-green").addClass(progressClass);
            $("#collex-box").removeClass("box-warning box-danger box-success").addClass(collexBox);
            if (enableTimeout) {
              setTimeout(callAPI, 10000);
            }
          }
        });
      }

      var dTable = $('#surveys').DataTable({
        'paging': true,
        'lengthChange': false,
        'searching': true,
        'ordering': true,
        'info': true,
        'autoWidth': false,
        'scrollY': 350,
        'scroller': {
          loadingIndicator: true
        }
      })

      $('#survey-search').keyup(function () {
        dTable.search($(this).val()).draw();
      })


      $('#surveys tbody').on('click', 'tr', function () {
        var survey = dTable.row(this).data()[0];
        var id = dTable.row(this).id();

        $('#collex-id').data('collex', id)
        callAPI(id, false);
        $('#survey-name').text(survey)

        $('#modal-default').modal('toggle');

      });

    });
  </script>


</body>

</html>